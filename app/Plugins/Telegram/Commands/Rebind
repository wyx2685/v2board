<?php

namespace App\Plugins\Telegram\Commands;

use App\Models\User;
use App\Plugins\Telegram\Telegram;

class Rebind extends Telegram {
   public $command = '/rebind';
   public $description = 'é‡æ–°ç»‘å®šTelegramè´¦æˆ·åˆ°ç½‘ç«™';

   public function handle($message, $match = []) {
       if (!$message->is_private) return;
       
       if (!isset($message->args[0])) {
           $this->telegramService->sendMessage($message->chat_id, 
               "ğŸ“ å‘½ä»¤æ ¼å¼ï¼š\n\n" .
               "ğŸ”¹ ç”¨æˆ· â†’ ç”¨æˆ·ï¼ˆæ— éœ€éªŒè¯ï¼‰ï¼š\n" .
               "/rebind [è®¢é˜…åœ°å€]\n\n" .
               "ğŸ”¹ ç”¨æˆ· â†’ ç®¡ç†å‘˜ï¼ˆéœ€è¦å¯†ç ï¼‰ï¼š\n" .
               "/rebind [è®¢é˜…åœ°å€] [ç®¡ç†å‘˜å¯†ç ]\n\n" .
               "ğŸ”¹ ç®¡ç†å‘˜ â†’ ç®¡ç†å‘˜ï¼ˆéœ€è¦å¯†ç ï¼‰ï¼š\n" .
               "/rebind [è®¢é˜…åœ°å€] [ç®¡ç†å‘˜å¯†ç ]\n\n" .
               "ğŸ”¹ ç®¡ç†å‘˜ â†’ ç”¨æˆ·ï¼ˆæ— éœ€éªŒè¯ï¼‰ï¼š\n" .
               "/rebind [è®¢é˜…åœ°å€]\n\n" .
               "ç¤ºä¾‹ï¼š\n" .
               "/rebind https://site.com/subscribe?token=abc123\n" .
               "/rebind https://site.com/subscribe?token=xyz789 admin_password", 
               'markdown');
           return;
       }
       
       $subscribeUrl = $message->args[0];
       $password = $message->args[1] ?? null;
       
       $parsedUrl = parse_url($subscribeUrl);
       if (!isset($parsedUrl['query'])) {
           $this->telegramService->sendMessage($message->chat_id, 'âŒ è®¢é˜…åœ°å€æ ¼å¼æ— æ•ˆ', 'markdown');
           return;
       }
       
       parse_str($parsedUrl['query'], $query);
       $token = $query['token'] ?? null;
       
       if (!$token) {
           $this->telegramService->sendMessage($message->chat_id, 'âŒ è®¢é˜…åœ°å€ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆä»¤ç‰Œ', 'markdown');
           return;
       }
       
       $targetUser = User::where('token', $token)->first();
       if (!$targetUser) {
           $this->telegramService->sendMessage($message->chat_id, 'âŒ ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è®¢é˜…åœ°å€', 'markdown');
           return;
       }
       
       $currentUser = User::where('telegram_id', $message->chat_id)->first();
       
       $isCurrentUserAdmin = $currentUser ? $currentUser->is_admin : false;
       
       $isTargetUserAdmin = $targetUser->is_admin;
       
       if ($this->needsPasswordVerification($isCurrentUserAdmin, $isTargetUserAdmin)) {
           if (!$password) {
               $this->telegramService->sendMessage($message->chat_id, 
                   "ğŸ” ç»‘å®šç®¡ç†å‘˜è´¦æˆ·éœ€è¦å¯†ç \n\n" .
                   "æ ¼å¼ï¼š/rebind [è®¢é˜…åœ°å€] [å¯†ç ]\n\n" .
                   "ç¤ºä¾‹ï¼š/rebind {$subscribeUrl} admin_password", 
                   'markdown');
               return;
           }
           
           if (!password_verify($password, $targetUser->password)) {
               $this->telegramService->sendMessage($message->chat_id, 'âŒ å¯†ç é”™è¯¯', 'markdown');
               return;
           }
       }
       
       $existingUser = User::where('telegram_id', $message->chat_id)->first();
       if ($existingUser && $existingUser->id !== $targetUser->id) {
           $this->telegramService->sendMessage($message->chat_id, 
               "âŒ å½“å‰Telegramè´¦æˆ·å·²ç»‘å®šåˆ°å…¶ä»–ç”¨æˆ·\n\n" .
               "ğŸ“§ å½“å‰è´¦æˆ·ï¼š{$existingUser->email}\n" .
               "ğŸ“§ è¯·æ±‚è´¦æˆ·ï¼š{$targetUser->email}\n\n" .
               "å‘é€ /unbind è§£é™¤ç»‘å®š", 
               'markdown');
           return;
       }
       
       $targetUser->telegram_id = $message->chat_id;
       if (!$targetUser->save()) {
           $this->telegramService->sendMessage($message->chat_id, 'âŒ é‡æ–°ç»‘å®šå¤±è´¥ï¼Œè¯·é‡è¯•', 'markdown');
           return;
       }
       
       $targetUserType = $targetUser->is_admin ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘¤ ç”¨æˆ·';
       $currentUserType = $isCurrentUserAdmin ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘¤ ç”¨æˆ·';
       
       $this->telegramService->sendMessage($message->chat_id, 
           "âœ… é‡æ–°ç»‘å®šæˆåŠŸï¼\n\n" .
           "ğŸ”„ {$currentUserType} â†’ {$targetUserType}\n\n" .
           "ğŸ“§ é‚®ç®±ï¼š{$targetUser->email}\n" .
           "ğŸ†” IDï¼š{$targetUser->id}\n" .
           "ğŸ”° ç”¨æˆ·ç±»å‹ï¼š{$targetUserType}\n\n" .
           "ç°åœ¨æ‚¨å¯ä»¥å‘é€é¢‘é“åŠ å…¥è¯·æ±‚ã€‚", 
           'markdown');
   }
   
   /**
    * ç¡®å®šæ˜¯å¦éœ€è¦å¯†ç éªŒè¯
    */
   private function needsPasswordVerification($isCurrentUserAdmin, $isTargetUserAdmin)
   {
       if (!$isCurrentUserAdmin && !$isTargetUserAdmin) {
           return false;
       }
       
       if (!$isCurrentUserAdmin && $isTargetUserAdmin) {
           return true;
       }
       
       if ($isCurrentUserAdmin && $isTargetUserAdmin) {
           return true;
       }
       
       if ($isCurrentUserAdmin && !$isTargetUserAdmin) {
           return false;
       }
       
       return false;
   }
}
